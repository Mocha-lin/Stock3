<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bbb 投資戰情室</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-color: #FDFBF7; /* 淺米白色 */
            --sidebar-bg: #F5F2EB;
            --text-primary: #2C3E50;
            --accent-color: #8B7355; /* 雅緻棕 */
            --border-color: #E5E0D8;
            --risk-red: #E74C3C;
            --risk-green: #27AE60;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: 'Helvetica Neue', Arial, 'Heiti TC', sans-serif;
            overflow: hidden; /* 防止整個頁面滾動，只讓區塊滾動 */
        }

        /* 滾動條美化 */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #D1C7B7;
            border-radius: 4px;
        }

        /* 風險預警閃爍動畫 */
        @keyframes flash-warning {
            0% { background-color: rgba(231, 76, 60, 0.1); box-shadow: 0 0 5px rgba(231, 76, 60, 0.5); }
            50% { background-color: rgba(231, 76, 60, 0.3); box-shadow: 0 0 15px rgba(231, 76, 60, 0.8); }
            100% { background-color: rgba(231, 76, 60, 0.1); box-shadow: 0 0 5px rgba(231, 76, 60, 0.5); }
        }

        @keyframes flash-success {
            0% { background-color: rgba(39, 174, 96, 0.1); }
            50% { background-color: rgba(39, 174, 96, 0.3); }
            100% { background-color: rgba(39, 174, 96, 0.1); }
        }

        .alert-flash-red {
            animation: flash-warning 2s infinite;
            border: 1px solid var(--risk-red);
            color: var(--risk-red);
        }

        .alert-flash-green {
            animation: flash-success 2s infinite;
            border: 1px solid var(--risk-green);
            color: var(--risk-green);
        }

        .table-header {
            background-color: #EFEBE0;
            color: #5D5D5D;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .section-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.02);
            margin-bottom: 1.5rem;
            padding: 1.5rem;
        }

        .category-header {
            font-size: 0.75rem;
            color: #888;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            padding-left: 0.5rem;
            border-bottom: 1px dashed #ccc;
        }

        /* 拖曳相關 */
        .draggable-item {
            cursor: grab;
        }
        .draggable-item:active {
            cursor: grabbing;
        }
        .dragging {
            opacity: 0.5;
            background: #e0e0e0;
        }

        /* 響應式字體調整 */
        @media (max-width: 768px) {
            .main-container { flex-direction: column; }
            .sidebar { width: 100% !important; height: auto !important; max-height: 200px; }
            .content { width: 100% !important; }
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- 頂部導航 (手機版可見，桌面版簡單顯示 Logo) -->
    <header class="bg-[#ECE8DE] h-12 flex items-center px-6 border-b border-[#DCD6C9] shrink-0">
        <div class="font-bold text-lg tracking-widest text-[#5A4A42]">bbb ANALYTICS</div>
    </header>

    <!-- 主容器 -->
    <div class="flex flex-1 overflow-hidden main-container">
        
        <!-- 左側邊欄 (1/6) -->
        <aside class="w-1/6 bg-[#F5F2EB] border-r border-[#DCD6C9] flex flex-col z-10 sidebar relative">
            
            <!-- 搜尋與工具列 -->
            <div class="p-3 border-b border-[#E5E0D8] bg-[#F5F2EB]">
                <div class="relative">
                    <input type="text" id="searchInput" placeholder="搜尋代號或名稱..." 
                           class="w-full bg-white border border-[#D1C7B7] rounded px-3 py-1.5 text-sm focus:outline-none focus:border-[#8B7355]">
                    <i class="fas fa-search absolute right-3 top-2 text-gray-400 text-xs"></i>
                </div>
            </div>

            <!-- 股票清單 (可拖曳與滾動) -->
            <div id="stockListContainer" class="flex-1 overflow-y-auto p-2">
                <!-- 動態生成股票列表 -->
            </div>

            <!-- 底部功能區 -->
            <div class="p-3 border-t border-[#E5E0D8] bg-[#EFEBE0] text-center text-xs text-gray-500">
                <button onclick="createNewEntry()" class="w-full bg-[#8B7355] hover:bg-[#6d5a41] text-white py-2 rounded shadow transition">
                    <i class="fas fa-plus mr-1"></i> 新增分析
                </button>
            </div>
        </aside>

        <!-- 右側內容區 (5/6) -->
        <main class="w-5/6 flex-1 overflow-y-auto bg-white/50 p-6 content relative scroll-smooth" id="mainContent">
            
            <!-- JSON 輸入區 (平時隱藏，新增時顯示) -->
            <div id="jsonInputArea" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
                <div class="bg-white w-2/3 h-3/4 rounded-lg shadow-2xl flex flex-col p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-[#8B7355]">匯入 bbb 模型數據</h2>
                        <button onclick="closeJsonInput()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                    </div>
                    <textarea id="jsonRawInput" class="flex-1 border border-gray-300 rounded p-4 font-mono text-sm bg-[#F9F9F9] focus:outline-none focus:border-[#8B7355]" 
                              placeholder="請將 bbb 生成的 JSON 代碼完整貼於此處..."></textarea>
                    <div class="mt-4 flex justify-end gap-3">
                        <button onclick="importSampleData()" class="text-gray-500 text-sm hover:underline px-4">匯入範例數據</button>
                        <button onclick="processJsonImport()" class="bg-[#8B7355] text-white px-6 py-2 rounded hover:bg-[#6d5a41] transition">
                            <i class="fas fa-file-import mr-2"></i>確認匯入
                        </button>
                    </div>
                </div>
            </div>

            <!-- 空白狀態 -->
            <div id="emptyState" class="h-full flex flex-col items-center justify-center text-gray-400">
                <i class="fas fa-chart-line text-6xl mb-4 text-[#D1C7B7]"></i>
                <p class="text-lg">請選擇左側股票或新增分析</p>
            </div>

            <!-- 分析報告顯示區 -->
            <div id="reportContainer" class="hidden max-w-7xl mx-auto space-y-6">
                
                <!-- 標題與即時資訊 -->
                <div class="flex justify-between items-end border-b-2 border-[#8B7355] pb-2 mb-6">
                    <div>
                        <h1 class="text-4xl font-bold text-[#2C3E50] tracking-tight">
                            <span id="stockId" class="text-[#8B7355] mr-2"></span>
                            <span id="stockName"></span>
                        </h1>
                        <p class="text-sm text-gray-500 mt-1">更新日期：<span id="updateDate"></span> | 拆分備註：<span id="splitNote"></span></p>
                    </div>
                    <div class="text-right">
                        <div id="priceDisplay" class="text-3xl font-mono font-bold"></div>
                        <div id="priceChange" class="text-sm font-medium"></div>
                    </div>
                </div>

                <!-- 備忘錄區 (自動儲存) -->
                <div class="section-card bg-[#FFFDF5] border-[#E8E0C0]">
                    <h3 class="text-sm font-bold text-[#8B7355] mb-2 uppercase"><i class="fas fa-sticky-note mr-2"></i>投資筆記 (Memo)</h3>
                    <textarea id="memoArea" class="w-full bg-transparent border-none resize-none text-gray-700 focus:ring-0 text-base" rows="3" placeholder="在此輸入您的個人筆記，系統將自動儲存..."></textarea>
                </div>

                <!-- 兩欄佈局：左資訊，右圖表 -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    
                    <!-- 區塊一：基本面與消息 -->
                    <div class="space-y-6">
                        <!-- 護城河 -->
                        <div class="section-card">
                            <h3 class="text-lg font-bold text-[#2C3E50] mb-3 border-b pb-2">護城河與產業鏈</h3>
                            <div class="space-y-2 text-sm">
                                <p><span class="font-bold text-gray-600">狀態：</span> <span id="moatStatus"></span></p>
                                <p><span class="font-bold text-gray-600">上下游：</span> <span id="supplyChain"></span></p>
                                <p><span class="font-bold text-gray-600">競爭者：</span> <span id="competitors"></span></p>
                                <div class="p-2 bg-gray-50 rounded mt-2 text-gray-700 italic" id="moatDesc"></div>
                            </div>
                        </div>

                        <!-- 消息面 -->
                        <div class="section-card">
                            <h3 class="text-lg font-bold text-[#2C3E50] mb-3 border-b pb-2">近日消息與利多利空</h3>
                            <ul id="newsList" class="space-y-2 text-sm">
                                <!-- JS 填入 -->
                            </ul>
                        </div>
                    </div>

                    <!-- 區塊二：財務數據視覺化 -->
                    <div class="section-card flex flex-col">
                        <h3 class="text-lg font-bold text-[#2C3E50] mb-3 border-b pb-2">多維度財務圖表</h3>
                        <div class="flex-1 min-h-[300px]">
                            <canvas id="financialChart"></canvas>
                        </div>
                        <div class="grid grid-cols-3 gap-2 mt-4 text-center text-sm">
                            <div class="p-2 bg-gray-50 rounded">
                                <div class="text-gray-500 text-xs">P/B 比</div>
                                <div id="pbValue" class="font-bold text-lg"></div>
                            </div>
                            <div class="p-2 bg-gray-50 rounded">
                                <div class="text-gray-500 text-xs">ROE</div>
                                <div id="roeValue" class="font-bold text-lg"></div>
                            </div>
                             <div class="p-2 bg-gray-50 rounded">
                                <div class="text-gray-500 text-xs">PE 狀態</div>
                                <div id="peStatus" class="font-bold text-[#8B7355]"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 區塊三：詳細財務表格 -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                     <!-- EPS 表格 -->
                    <div class="section-card">
                        <h3 class="text-lg font-bold text-[#2C3E50] mb-3">EPS 預估 (龍頭券商)</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="table-header">
                                    <tr>
                                        <th class="p-2">日期</th>
                                        <th class="p-2">毛利%</th>
                                        <th class="p-2">淨利%</th>
                                        <th class="p-2">EPS</th>
                                        <th class="p-2">累計</th>
                                    </tr>
                                </thead>
                                <tbody id="epsTableBody" class="divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 月營收表格 -->
                    <div class="section-card">
                        <h3 class="text-lg font-bold text-[#2C3E50] mb-3">月營收 (WantGoo)</h3>
                        <div class="overflow-x-auto max-h-64">
                            <table class="w-full text-sm text-left">
                                <thead class="table-header">
                                    <tr>
                                        <th class="p-2">月份</th>
                                        <th class="p-2">營收</th>
                                        <th class="p-2">YoY%</th>
                                        <th class="p-2">MoM%</th>
                                    </tr>
                                </thead>
                                <tbody id="revenueTableBody" class="divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 區塊四：技術分析與預測 (含風險警示) -->
                <div class="section-card border-l-4 border-[#8B7355]">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h3 class="text-lg font-bold text-[#2C3E50]">技術分析與 AI 預測 (校正係數 C: <span id="correctionC"></span>)</h3>
                        <div id="bollingerAlert" class="hidden px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide"></div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <p class="text-sm text-gray-600 mb-4 leading-relaxed" id="klineAnalysis"></p>
                            <div class="bg-gray-50 p-3 rounded border border-gray-200">
                                <div class="text-xs text-gray-500 uppercase font-bold mb-2">布林通道狀態</div>
                                <p id="bollingerDesc" class="text-sm font-medium"></p>
                            </div>
                             <div class="bg-gray-50 p-3 rounded border border-gray-200 mt-2">
                                <div class="text-xs text-gray-500 uppercase font-bold mb-2">目前狀態</div>
                                <p id="marketStatus" class="text-sm font-bold text-[#8B7355]"></p>
                            </div>
                        </div>
                        
                        <!-- 價格預測 -->
                        <div class="space-y-3">
                            <div class="flex justify-between items-center p-2 bg-white border rounded shadow-sm">
                                <span class="text-xs font-bold text-gray-500">未來 30 天</span>
                                <span id="pred30" class="font-mono font-bold text-gray-800"></span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-white border rounded shadow-sm">
                                <span class="text-xs font-bold text-gray-500">未來 180 天</span>
                                <span id="pred180" class="font-mono font-bold text-gray-800"></span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-white border rounded shadow-sm">
                                <span class="text-xs font-bold text-gray-500">未來 360 天</span>
                                <span id="pred360" class="font-mono font-bold text-gray-800"></span>
                            </div>
                            <div class="mt-4 p-3 bg-[#F5F2EB] rounded text-center">
                                <span class="text-xs text-[#8B7355] block mb-1">建議進場區間</span>
                                <span id="entryZone" class="text-lg font-bold text-[#2C3E50]"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 區塊五：股利與報酬率推估 -->
                <div class="section-card">
                    <h3 class="text-lg font-bold text-[#2C3E50] mb-3">除權息與年化報酬率 (配息再投入)</h3>
                    <div class="flex flex-col md:flex-row gap-6">
                        <div class="w-full md:w-1/2">
                            <p class="text-sm text-gray-600 mb-2" id="dividendInfo"></p>
                            <div class="h-48">
                                <canvas id="dividendChart"></canvas>
                            </div>
                        </div>
                        <div class="w-full md:w-1/2 flex flex-col justify-center">
                            <div class="p-4 bg-[#F9F7F1] border border-[#E5E0D8] rounded-lg text-center">
                                <div class="text-sm text-gray-500 mb-2">接續年次預估年化報酬</div>
                                <div id="projectedReturn" class="text-2xl font-bold text-[#8B7355]"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 底部留白 -->
                <div class="h-20"></div>
            </div>
        </main>
    </div>

    <script>
        // --- State Management ---
        let stocks = [];
        let currentStockId = null;
        let financialChartInstance = null;
        let dividendChartInstance = null;

        // --- Initialization ---
        window.onload = function() {
            loadFromStorage();
            renderSidebar();
        };

        // --- Data Handling ---
        function loadFromStorage() {
            const saved = localStorage.getItem('bbb_stocks');
            if (saved) {
                stocks = JSON.parse(saved);
            }
        }

        function saveToStorage() {
            localStorage.setItem('bbb_stocks', JSON.stringify(stocks));
        }

        function createNewEntry() {
            document.getElementById('jsonInputArea').classList.remove('hidden');
            document.getElementById('jsonRawInput').value = '';
            document.getElementById('jsonRawInput').focus();
        }

        function closeJsonInput() {
            document.getElementById('jsonInputArea').classList.add('hidden');
        }

        function importSampleData() {
            const sample = {
                "id": "2330",
                "name": "台積電",
                "lastUpdated": "2025-05-20",
                "basicInfo": {
                    "price": "1050.00", "change": "+15.00", "changePercent": "+1.45%", "splitNote": "近年無拆分", "riskStatus": "bullish", "riskLabel": "多頭"
                },
                "news": [
                    {"date": "2025-05-19", "title": "台積電先進封裝產能供不應求", "type": "positive"},
                    {"date": "2025-05-18", "title": "外資小幅調節半導體持股", "type": "neutral"}
                ],
                "moat": {
                    "status": "極寬護城河", "supplyChain": "上游：ASML；下游：Apple", "competitors": "Intel (落後)", "description": "先進製程與專利壁壘。"
                },
                "financials": {
                    "epsEstimates": [
                        {"date": "2024", "grossMargin": "53.1", "netMargin": "40.2", "eps": "42.10", "cumulativeEps": "42.10"},
                        {"date": "2025E", "grossMargin": "54.5", "netMargin": "41.5", "eps": "50.50", "cumulativeEps": "92.60"}
                    ],
                    "revenue": [
                         {"month": "2024-12", "amount": "2700億", "yoy": "+42.0%", "mom": "+5.8%"},
                         {"month": "2025-01", "amount": "2650億", "yoy": "+39.5%", "mom": "-1.8%"}
                    ],
                    "peRiver": {"currentPE": "22.5", "position": "中低", "status": "合理", "discrepancyNote": ""},
                    "pb": "5.8", "roe": "28.5%", "roa": "18.2%"
                },
                "technical": {
                    "analysis": "K線多頭排列。",
                    "predictions": {"days30": "1080-1120", "days180": "1150-1250", "days360": "1300+", "entryZone": "1030-1050"},
                    "correctionC": "0.92",
                    "bollinger": {"status": "upper_band_touch", "alert": "超買預警", "description": "觸及上軌，注意乖離"},
                    "marketStatus": "大漲"
                },
                "dividend": {
                    "info": "每季配息 4.0 元",
                    "annualReturns": [{"year": "2023", "return": "35.2%"}, {"year": "2024", "return": "50.1%"}],
                    "projectedReturn": "15%-20%"
                },
                "chartsData": {
                    "revenueTrend": [2100, 2250, 2400, 2500, 2700, 2650],
                    "epsTrend": [39.2, 42.1, 50.5, 58.0],
                    "epsLabels": ["23", "24", "25E", "26E"],
                    "peValues": [15, 18, 22.5, 28]
                },
                "memo": "" // Init memo
            };
            document.getElementById('jsonRawInput').value = JSON.stringify(sample, null, 2);
        }

        function processJsonImport() {
            const raw = document.getElementById('jsonRawInput').value;
            try {
                const data = JSON.parse(raw);
                // 檢查是否已存在，若存在則更新，否則新增
                const index = stocks.findIndex(s => s.id === data.id);
                
                // 保留舊的備忘錄如果存在
                if(index !== -1 && stocks[index].memo) {
                    data.memo = stocks[index].memo;
                } else {
                    data.memo = "";
                }

                // 分類處理 (簡易版：根據屬性自動分，這裡預設為 "未分類" 或根據 ID 判斷)
                data.category = "一般持股"; 
                if(data.moat && data.moat.supplyChain.includes("上游")) data.category = "上游供應鏈";

                if (index !== -1) {
                    stocks[index] = data;
                } else {
                    stocks.unshift(data); // 加到最上面
                }
                
                saveToStorage();
                renderSidebar();
                loadStock(data.id);
                closeJsonInput();
            } catch (e) {
                alert("JSON 格式錯誤，請檢查代碼是否完整。\n" + e.message);
            }
        }

        // --- Sidebar Logic ---
        function renderSidebar() {
            const container = document.getElementById('stockListContainer');
            const search = document.getElementById('searchInput').value.toLowerCase();
            container.innerHTML = '';

            // Group by category (simple logic)
            const categories = {};
            
            stocks.forEach(stock => {
                if (search && !stock.id.includes(search) && !stock.name.includes(search)) return;
                
                const cat = stock.category || "未分類";
                if (!categories[cat]) categories[cat] = [];
                categories[cat].push(stock);
            });

            for (const [catName, items] of Object.entries(categories)) {
                const catHeader = document.createElement('div');
                catHeader.className = 'category-header';
                catHeader.innerText = catName;
                container.appendChild(catHeader);

                items.forEach(stock => {
                    const el = document.createElement('div');
                    el.className = `p-3 mb-1 rounded cursor-pointer draggable-item hover:bg-white transition flex justify-between items-center ${stock.id === currentStockId ? 'bg-white shadow border-l-4 border-[#8B7355]' : 'border border-transparent'}`;
                    
                    // 風險與漲跌狀態
                    let statusColor = "text-gray-400";
                    let icon = "fa-minus";
                    if(stock.basicInfo.change.includes("+")) { statusColor = "text-[#E74C3C]"; icon = "fa-arrow-up"; } // 台股紅漲
                    if(stock.basicInfo.change.includes("-")) { statusColor = "text-[#27AE60]"; icon = "fa-arrow-down"; } // 台股綠跌
                    
                    // 警示燈
                    let alertDot = "";
                    if (stock.technical && stock.technical.bollinger && stock.technical.bollinger.alert) {
                         alertDot = `<span class="h-2 w-2 rounded-full bg-red-500 animate-ping absolute top-2 right-2"></span>`;
                    }

                    el.innerHTML = `
                        <div class="relative w-full">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-[#2C3E50]">${stock.id} ${stock.name}</span>
                                <span class="text-xs ${statusColor} font-mono">${stock.basicInfo.changePercent}</span>
                            </div>
                            <div class="flex justify-between mt-1">
                                <span class="text-xs text-gray-500 truncate w-24">${stock.technical.marketStatus || '分析中'}</span>
                                <span class="text-xs bg-gray-200 px-1 rounded text-gray-600">${stock.basicInfo.price}</span>
                            </div>
                            ${alertDot}
                        </div>
                    `;
                    el.onclick = () => loadStock(stock.id);
                    container.appendChild(el);
                });
            }
        }

        document.getElementById('searchInput').addEventListener('input', renderSidebar);

        // --- Main Content Rendering ---
        function loadStock(id) {
            currentStockId = id;
            const data = stocks.find(s => s.id === id);
            if (!data) return;

            // UI Toggle
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('reportContainer').classList.remove('hidden');
            renderSidebar(); // Update active state

            // Header
            document.getElementById('stockId').innerText = data.id;
            document.getElementById('stockName').innerText = data.name;
            document.getElementById('updateDate').innerText = data.lastUpdated;
            document.getElementById('splitNote').innerText = data.basicInfo.splitNote;
            
            const priceEl = document.getElementById('priceDisplay');
            const changeEl = document.getElementById('priceChange');
            priceEl.innerText = data.basicInfo.price;
            changeEl.innerText = `${data.basicInfo.change} (${data.basicInfo.changePercent})`;
            
            // 台股顏色邏輯
            if (data.basicInfo.change.includes('+')) {
                priceEl.className = "text-3xl font-mono font-bold text-[#E74C3C]";
                changeEl.className = "text-sm font-medium text-[#E74C3C]";
            } else if (data.basicInfo.change.includes('-')) {
                priceEl.className = "text-3xl font-mono font-bold text-[#27AE60]";
                changeEl.className = "text-sm font-medium text-[#27AE60]";
            } else {
                priceEl.className = "text-3xl font-mono font-bold text-gray-800";
                changeEl.className = "text-sm font-medium text-gray-800";
            }

            // Memo
            const memoArea = document.getElementById('memoArea');
            memoArea.value = data.memo || "";
            memoArea.oninput = function() {
                data.memo = this.value;
                saveToStorage();
            };

            // Moat
            document.getElementById('moatStatus').innerText = data.moat.status;
            document.getElementById('supplyChain').innerText = data.moat.supplyChain;
            document.getElementById('competitors').innerText = data.moat.competitors;
            document.getElementById('moatDesc').innerText = data.moat.description;

            // News
            const newsList = document.getElementById('newsList');
            newsList.innerHTML = '';
            data.news.forEach(n => {
                const li = document.createElement('li');
                const colorClass = n.type === 'positive' ? 'text-red-600' : (n.type === 'negative' ? 'text-green-600' : 'text-gray-600');
                li.innerHTML = `<span class="text-gray-400 text-xs mr-2 font-mono">${n.date}</span><span class="${colorClass}">${n.title}</span>`;
                newsList.appendChild(li);
            });

            // Financial Indicators
            document.getElementById('pbValue').innerText = data.financials.pb;
            document.getElementById('roeValue').innerText = data.financials.roe;
            document.getElementById('peStatus').innerText = `${data.financials.peRiver.currentPE} (${data.financials.peRiver.status})`;

            // Tables
            renderTable('epsTableBody', data.financials.epsEstimates, ['date', 'grossMargin', 'netMargin', 'eps', 'cumulativeEps']);
            renderTable('revenueTableBody', data.financials.revenue, ['month', 'amount', 'yoy', 'mom']);

            // Technical
            document.getElementById('klineAnalysis').innerText = data.technical.analysis;
            document.getElementById('pred30').innerText = data.technical.predictions.days30;
            document.getElementById('pred180').innerText = data.technical.predictions.days180;
            document.getElementById('pred360').innerText = data.technical.predictions.days360;
            document.getElementById('entryZone').innerText = data.technical.predictions.entryZone;
            document.getElementById('correctionC').innerText = data.technical.correctionC;
            document.getElementById('marketStatus').innerText = data.technical.marketStatus;

            // Bollinger Alert
            const bollingerAlert = document.getElementById('bollingerAlert');
            document.getElementById('bollingerDesc').innerText = data.technical.bollinger.description;
            
            bollingerAlert.className = "hidden px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide"; // reset
            if (data.technical.bollinger.alert) {
                bollingerAlert.classList.remove('hidden');
                bollingerAlert.innerText = data.technical.bollinger.alert;
                if(data.technical.bollinger.alert.includes("超買") || data.technical.bollinger.status === 'upper_band_touch') {
                    bollingerAlert.classList.add('alert-flash-red', 'bg-red-50');
                } else if (data.technical.bollinger.alert.includes("破底") || data.technical.bollinger.status === 'lower_band_touch') {
                    bollingerAlert.classList.add('alert-flash-green', 'bg-green-50'); // 台股低接綠色概念? 通常破底是危險，但如果是超賣反彈訊號則...依照題目要求標示即可，這裡用綠色區分
                } else {
                     bollingerAlert.classList.add('bg-yellow-100', 'text-yellow-800');
                }
            }

            // Dividend
            document.getElementById('dividendInfo').innerText = data.dividend.info;
            document.getElementById('projectedReturn').innerText = data.dividend.projectedReturn;

            // Charts
            renderCharts(data);
        }

        function renderTable(id, data, keys) {
            const tbody = document.getElementById(id);
            tbody.innerHTML = '';
            data.forEach(row => {
                const tr = document.createElement('tr');
                keys.forEach(key => {
                    const td = document.createElement('td');
                    td.className = "p-2";
                    td.innerText = row[key];
                    // 簡單著色
                    if(row[key].includes && (row[key].includes('+') || row[key].includes('-'))) {
                        td.className += row[key].includes('+') ? " text-red-600" : " text-green-600";
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        function renderCharts(data) {
            // Destroy old charts
            if (financialChartInstance) financialChartInstance.destroy();
            if (dividendChartInstance) dividendChartInstance.destroy();

            // 1. Multi-dimensional Chart (Combo of Revenue Line & EPS Bar)
            // 由於 scale 不同，這裡做示意整合
            const ctxFin = document.getElementById('financialChart').getContext('2d');
            
            // 如果數據長度不對等，簡單截斷或補齊，這裡假設 bbb 會給出對應長度
            // 為了美觀，這裡混合使用 chartsData 中的不同數據源
            
            financialChartInstance = new Chart(ctxFin, {
                type: 'line',
                data: {
                    labels: data.financials.revenue.map(r => r.month).reverse(), // 營收通常最新在第0個
                    datasets: [
                        {
                            label: '月營收 (線圖)',
                            data: data.chartsData.revenueTrend || [],
                            borderColor: '#8B7355',
                            backgroundColor: 'rgba(139, 115, 85, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            yAxisID: 'y'
                        },
                         {
                            type: 'bar',
                            label: 'PE 歷史估值',
                            data: data.chartsData.peValues || [], // 假設這跟月份對應，實際可能需要調整 labels
                            backgroundColor: '#D1C7B7',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { position: 'bottom' } },
                    scales: {
                        y: { type: 'linear', display: true, position: 'left', grid: { display: false } },
                        y1: { type: 'linear', display: true, position: 'right', grid: { display: false } }
                    }
                }
            });

            // 2. EPS Growth & Dividend Return (分開畫或合併，這裡畫年化報酬直條)
            const ctxDiv = document.getElementById('dividendChart').getContext('2d');
            const years = data.dividend.annualReturns.map(d => d.year);
            const returns = data.dividend.annualReturns.map(d => parseFloat(d.return));

            dividendChartInstance = new Chart(ctxDiv, {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [{
                        label: '年化報酬率 (%)',
                        data: returns,
                        backgroundColor: returns.map(v => v > 0 ? '#E74C3C' : '#27AE60'), // 紅漲綠跌
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: '#f0f0f0' } }
                    }
                }
            });
        }

    </script>
</body>
</html>